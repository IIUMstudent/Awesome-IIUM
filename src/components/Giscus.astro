---
/**
 * Giscus component
 *
 * Purpose: Replace the Starlight footer with a Giscus comments section.
 * Usage: Configured as the Starlight Footer component in astro.config.mjs.
 * Props: Inherits Starlight Footer props (no custom props).
 * Client behavior: Injects Giscus client script when visible.
 * API dependencies: Giscus (giscus.app) and GitHub Discussions.
 */
// biome-ignore lint/correctness/noUnusedImports: Used in template
import Default from '@astrojs/starlight/components/Footer.astro';
// biome-ignore lint/correctness/noUnusedImports: Implicitly used
import type { Props } from '@astrojs/starlight/props';
import { GITHUB_REPO } from '../config';

// biome-ignore lint/correctness/noUnusedVariables: passed to client script
const repoFullName = GITHUB_REPO.fullName;
---

<Default {...Astro.props} />

<div class="footer-links" role="contentinfo">
  <a
    href="https://github.com/iiumstudent/Awesome-IIUM/blob/master/PRIVACY.md"
    target="_blank"
    rel="noopener"
  >
    Privacy Policy
  </a>
</div>

<div class="giscus-container" id="giscus-container">
  <!-- Giscus will be injected here when visible -->
</div>

<script define:vars={{ repoFullName }}>
  function loadGiscus() {
    const container = document.getElementById('giscus-container');
    if (!container || container.querySelector('script[src*="giscus.app"]')) return;

    const script = document.createElement('script');
    script.src = "https://giscus.app/client.js";
    script.setAttribute("data-repo", repoFullName);
    script.setAttribute("data-repo-id", "R_kgDONpSk3Q");
    script.setAttribute("data-category", "Announcements");
    script.setAttribute("data-category-id", "DIC_kwDONpSk3c4CmD1H");
    script.setAttribute("data-mapping", "pathname");
    script.setAttribute("data-strict", "0");
    script.setAttribute("data-reactions-enabled", "1");
    script.setAttribute("data-emit-metadata", "0");
    script.setAttribute("data-input-position", "bottom");
    script.setAttribute("data-theme", "preferred_color_scheme");
    script.setAttribute("data-lang", "en");
    script.crossOrigin = "anonymous";
    script.async = true;

    container.appendChild(script);
  }

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        loadGiscus();
        observer.disconnect();
      }
    });
  }, { rootMargin: '200px' });

  const container = document.getElementById('giscus-container');
  if (container) {
    observer.observe(container);
  }
</script>

<style>
  .giscus-container {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid var(--sl-color-hairline-light);
    min-height: 200px; /* Reserve some space to prevent layout shift */
  }

  .footer-links {
    margin-top: 0.75rem;
    font-size: 0.875rem;
  }

  .footer-links a {
    color: var(--sl-color-text-accent);
    text-decoration: none;
  }

  .footer-links a:hover,
  .footer-links a:focus-visible {
    text-decoration: underline;
  }
</style>
