---
import { mkdir, readFile, writeFile } from 'node:fs/promises';
import { join } from 'node:path';
import { GITHUB_REPO } from '../config';

/**
 * ActivityFeed Component
 * Shows recent activity from the GitHub repository
 */
interface Activity {
	type: 'commit' | 'pr' | 'issue';
	title: string;
	user: string;
	avatar: string;
	url: string;
	date: string;
	timestamp: number;
	icon: string;
}

async function fetchActivity(): Promise<Activity[]> {
	const CACHE_DIR = join(
		process.cwd(),
		'node_modules',
		'.cache',
		'awesome-iium',
	);
	const CACHE_FILE = join(CACHE_DIR, 'activity-feed.json');
	const CACHE_TTL = 3600 * 1000; // 1 hour

	const activities: Activity[] = [];

	// Try reading from cache
	try {
		const cachedData = await readFile(CACHE_FILE, 'utf-8');
		const cache = JSON.parse(cachedData);
		const now = Date.now();
		if (now - cache.timestamp < CACHE_TTL) {
			// Sort by date (most recent first) just in case
			cache.data.sort(
				(a: Activity, b: Activity) =>
					(b.timestamp ?? new Date(b.date).getTime()) -
					(a.timestamp ?? new Date(a.date).getTime()),
			);
			return cache.data.slice(0, 5);
		}
	} catch {
		// Cache miss or error, proceed to fetch
	}

	try {
		// Parallelize API fetches
		const [commitsRes, prsRes] = await Promise.all([
			fetch(`${GITHUB_REPO.apiUrl}/commits?per_page=3`),
			fetch(`${GITHUB_REPO.apiUrl}/pulls?state=all&per_page=2`),
		]);

		// Process commits
		if (commitsRes.ok) {
			const commits = await commitsRes.json();
			for (const commit of commits) {
				activities.push({
					type: 'commit',
					title: commit.commit.message.split('\n')[0].substring(0, 60),
					user: commit.author?.login || commit.commit.author.name,
					avatar: commit.author?.avatar_url || 'https://github.com/ghost.png',
					url: commit.html_url,
					date: new Date(commit.commit.author.date).toLocaleDateString(),
					timestamp: new Date(commit.commit.author.date).getTime(),
					icon: 'ðŸ“',
				});
			}
		}

		// Process pull requests
		if (prsRes.ok) {
			const prs = await prsRes.json();
			for (const pr of prs) {
				activities.push({
					type: 'pr',
					title: pr.title.substring(0, 60),
					user: pr.user.login,
					avatar: pr.user.avatar_url,
					url: pr.html_url,
					date: new Date(pr.created_at).toLocaleDateString(),
					timestamp: new Date(pr.created_at).getTime(),
					icon: 'ðŸ”€',
				});
			}
		}

		// Sort by date (most recent first)
		activities.sort((a, b) => b.timestamp - a.timestamp);

		// Save to cache
		try {
			await mkdir(CACHE_DIR, { recursive: true });
			await writeFile(
				CACHE_FILE,
				JSON.stringify({
					timestamp: Date.now(),
					data: activities,
				}),
			);
		} catch (e) {
			console.error('Failed to write cache:', e);
		}

		return activities.slice(0, 5);
	} catch (e) {
		console.error('ActivityFeed Error:', e);

		// If fetch fails, try to use stale cache
		try {
			const cachedData = await readFile(CACHE_FILE, 'utf-8');
			const cache = JSON.parse(cachedData);
			cache.data.sort(
				(a: Activity, b: Activity) =>
					(b.timestamp ?? new Date(b.date).getTime()) -
					(a.timestamp ?? new Date(a.date).getTime()),
			);
			return cache.data.slice(0, 5);
		} catch {
			// No cache available
		}

		return [];
	}
}

// biome-ignore lint/correctness/noUnusedVariables: used in template
const activities = await fetchActivity();
---

<div class="activity-feed not-content">
  <h3>ðŸ“¡ Recent Activity</h3>
  
  {activities.length > 0 ? (
    <ul class="activity-list">
      {activities.map((activity) => (
        <li class={`activity-item activity-${activity.type}`}>
          <img 
            src={activity.avatar} 
            alt={activity.user} 
            class="avatar"
            loading="lazy"
          />
          <div class="activity-content">
            <a href={activity.url} target="_blank" rel="noopener noreferrer">
              <span class="icon">{activity.icon}</span>
              <span class="title">{activity.title}</span>
            </a>
            <div class="meta">
              <span class="user">@{activity.user}</span>
              <span class="dot">â€¢</span>
              <span class="date">{activity.date}</span>
            </div>
          </div>
        </li>
      ))}
    </ul>
  ) : (
    <p class="no-activity">No recent activity</p>
  )}
  
  <a href={`${GITHUB_REPO.url}/commits/master`} class="view-all">
    View all activity â†’
  </a>
</div>

<style>
  .activity-feed {
    background: var(--sl-color-bg-nav);
    border: 1px solid var(--sl-color-hairline-light);
    border-radius: 12px;
    padding: 1.25rem;
    margin: 1.5rem 0;
  }

  .activity-feed h3 {
    margin: 0 0 1rem 0;
    font-size: 1rem;
    font-weight: 600;
  }

  .activity-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .activity-item {
    display: flex;
    gap: 0.75rem;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--sl-color-hairline-light);
  }

  .activity-item:last-child {
    border-bottom: none;
  }

  .avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .activity-content {
    min-width: 0;
    flex: 1;
  }

  .activity-content a {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    text-decoration: none;
    color: inherit;
    font-size: 0.875rem;
    line-height: 1.4;
  }

  .activity-content a:hover .title {
    color: var(--sl-color-accent);
  }

  .icon {
    flex-shrink: 0;
  }

  .title {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    transition: color 0.15s;
  }

  .meta {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    margin-top: 0.25rem;
    font-size: 0.75rem;
    color: var(--sl-color-gray-3);
  }

  .dot {
    opacity: 0.5;
  }

  .view-all {
    display: block;
    text-align: center;
    margin-top: 1rem;
    padding-top: 0.75rem;
    border-top: 1px solid var(--sl-color-hairline-light);
    font-size: 0.875rem;
    color: var(--sl-color-accent);
    text-decoration: none;
  }

  .view-all:hover {
    text-decoration: underline;
  }

  .no-activity {
    text-align: center;
    color: var(--sl-color-gray-3);
    font-size: 0.875rem;
    margin: 1rem 0;
  }
</style>
