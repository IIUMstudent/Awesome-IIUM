---
/**
 * PrayerTimes component
 *
 * Purpose: Display daily prayer times for IIUM campuses with countdown.
 * Usage: <PrayerTimes /> on the dashboard page.
 * Props: None.
 * Client behavior: Hydrates client script for campus selection and countdown.
 * API dependencies: Aladhan API (timings endpoint).
 */
import { CAMPUSES } from '../utils/aladhan';

// biome-ignore lint/correctness/noUnusedVariables: passed to client script
const campuses = CAMPUSES;

// Default to Gombak
// biome-ignore lint/correctness/noUnusedVariables: passed to client script
const defaultCampus = 'gombak';
---

<div class="prayer-times not-content">
  <div class="header">
    <h3>üïå Prayer Times</h3>
    <select id="campus-selector" aria-label="Select campus">
      <option value="gombak">Gombak</option>
      <option value="kuantan">Kuantan</option>
      <option value="pagoh">Pagoh</option>
    </select>
  </div>

  <div id="hijri-date" class="hijri-date">Loading...</div>

  <div id="prayer-grid" class="prayer-grid">
    <div class="prayer-card loading">
      <span class="prayer-name">Loading...</span>
    </div>
  </div>

  <div id="next-prayer" class="next-prayer">
    <span class="label">Next Prayer</span>
    <span id="next-prayer-name" class="name">-</span>
    <span id="countdown" class="countdown">--:--:--</span>
  </div>

  <p class="attribution">
    Data from <a href="https://aladhan.com/" target="_blank" rel="noopener noreferrer">Aladhan.com</a>
    ‚Ä¢ Method: JAKIM (Malaysia)
  </p>
</div>

<script define:vars={{ campuses, defaultCampus }}>
  // Helper to prevent XSS
  function escapeHtml(unsafe) {
    if (typeof unsafe !== 'string') return unsafe;
    return unsafe
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  const prayers = [
    { key: 'Fajr', name: 'Subuh', arabic: 'ÿßŸÑŸÅÿ¨ÿ±' },
    { key: 'Sunrise', name: 'Syuruk', arabic: 'ÿßŸÑÿ¥ÿ±ŸàŸÇ' },
    { key: 'Dhuhr', name: 'Zohor', arabic: 'ÿßŸÑÿ∏Ÿáÿ±' },
    { key: 'Asr', name: 'Asar', arabic: 'ÿßŸÑÿπÿµÿ±' },
    { key: 'Maghrib', name: 'Maghrib', arabic: 'ÿßŸÑŸÖÿ∫ÿ±ÿ®' },
    { key: 'Isha', name: 'Isyak', arabic: 'ÿßŸÑÿπÿ¥ÿßÿ°' },
  ];

  let currentTimes = {};
  let countdownInterval;
  let parsedPrayers = [];
  let prayerCardElements = {};
  let currentNextPrayerKey = null;
  let cachedTargetTime = null;

  async function fetchPrayerTimes(campusKey) {
    const campus = campuses[campusKey];
    if (!campus) return;

    const today = new Date();
    const date = `${today.getDate()}-${today.getMonth() + 1}-${today.getFullYear()}`;
    const cacheKey = `iium-prayer-times-${campusKey}-${date}`;

    // Check cache first
    try {
      const cached = localStorage.getItem(cacheKey);
      if (cached) {
        const data = JSON.parse(cached);
        if (data && data.code === 200) {
          currentTimes = data.data.timings;
          renderTimes(data.data);
          return;
        }
      }
    } catch (e) {
      console.warn('Cache read error:', e);
    }
    
    try {
      const res = await fetch(
        `https://api.aladhan.com/v1/timings/${date}?latitude=${campus.lat}&longitude=${campus.lng}&method=3`
      );
      const data = await res.json();
      
      if (data.code === 200) {
        // Cache the successful response
        try {
          localStorage.setItem(cacheKey, JSON.stringify(data));
        } catch (e) {
          console.warn('Cache write error:', e);
        }

        currentTimes = data.data.timings;
        renderTimes(data.data);
      }
    } catch (e) {
      console.error('Failed to fetch prayer times:', e);
      document.getElementById('prayer-grid').innerHTML = 
        '<p class="error">Failed to load prayer times. Please try again.</p>';
    }
  }

  function renderTimes(data) {
    const grid = document.getElementById('prayer-grid');
    const hijriDiv = document.getElementById('hijri-date');
    
    // Render Hijri date
    const hijri = data.date.hijri;
    hijriDiv.textContent = `${hijri.day} ${hijri.month.en} ${hijri.year} AH`;

    // Pre-parse times
    parsedPrayers = prayers.map(prayer => {
      const time = data.timings[prayer.key];
      const [hours, minutes] = time.split(':').map(Number);
      return {
        ...prayer,
        hours,
        minutes,
        totalMinutes: hours * 60 + minutes
      };
    });
    
    // Render prayer times
    grid.innerHTML = parsedPrayers.map(prayer => `
      <div class="prayer-card" data-prayer="${escapeHtml(prayer.key)}">
        <span class="prayer-arabic">${escapeHtml(prayer.arabic)}</span>
        <span class="prayer-name">${escapeHtml(prayer.name)}</span>
        <span class="prayer-time">${escapeHtml(data.timings[prayer.key])}</span>
      </div>
    `).join('');

    // Cache DOM elements
    prayerCardElements = {};
    document.querySelectorAll('.prayer-card').forEach(card => {
      prayerCardElements[card.dataset.prayer] = card;
    });

    // Reset currentNextPrayerKey to force update
    currentNextPrayerKey = null;

    updateNextPrayer();
    startCountdown();
  }

  function updateNextPrayer(now = new Date()) {
    const currentMinutes = now.getHours() * 60 + now.getMinutes();
    
    let nextPrayer = null;
    let nextTime = null;

    for (const prayer of parsedPrayers) {
      if (prayer.totalMinutes > currentMinutes) {
        nextPrayer = prayer;
        nextTime = { hours: prayer.hours, minutes: prayer.minutes };
        break;
      }
    }

    // If no prayer found today, next is Fajr tomorrow
    if (!nextPrayer) {
      nextPrayer = parsedPrayers[0];
      // Default to 05:30 if parsing failed, though parsedPrayers[0] should be valid
      const hours = nextPrayer?.hours ?? 5;
      const minutes = nextPrayer?.minutes ?? 30;
      nextTime = { hours, minutes, tomorrow: true };
    }

    // Update cached target time
    if (nextTime) {
      const target = new Date(now);
      target.setHours(nextTime.hours, nextTime.minutes, 0, 0);

      if (nextTime.tomorrow) {
        target.setDate(target.getDate() + 1);
      }
      cachedTargetTime = target;
    }

    // Only update DOM if prayer changed
    if (nextPrayer && nextPrayer.key !== currentNextPrayerKey) {
      document.getElementById('next-prayer-name').textContent = nextPrayer.name;

      // Highlight current prayer using cached elements
      Object.values(prayerCardElements).forEach(card => card.classList.remove('next'));
      if (prayerCardElements[nextPrayer.key]) {
        prayerCardElements[nextPrayer.key].classList.add('next');
      }

      currentNextPrayerKey = nextPrayer.key;
    }

    return { nextPrayer, nextTime };
  }

  function startCountdown() {
    if (countdownInterval) clearInterval(countdownInterval);
    
    // Initial update to set cachedTargetTime
    updateNextPrayer();

    // Cache DOM elements to prevent querying every second
    const countdownEl = document.getElementById('countdown');
    const campusSelectEl = document.getElementById('campus-selector');

    countdownInterval = setInterval(() => {
      // Use cached target time to avoid recalculation and Date object creation
      if (!cachedTargetTime) {
        updateNextPrayer();
        if (!cachedTargetTime) return;
      }

      const now = new Date();
      const diff = cachedTargetTime - now;

      if (diff < 0) {
        // Refresh times when countdown ends
        if (campusSelectEl) {
          fetchPrayerTimes(campusSelectEl.value);
        } else {
          fetchPrayerTimes(defaultCampus);
        }
        return;
      }

      const hours = Math.floor(diff / 3600000);
      const minutes = Math.floor((diff % 3600000) / 60000);
      const seconds = Math.floor((diff % 60000) / 1000);

      if (countdownEl) {
        countdownEl.textContent =
          `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }
    }, 1000);
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    const selector = document.getElementById('campus-selector');
    const savedCampus = localStorage.getItem('iium-prayer-campus') || defaultCampus;
    
    selector.value = savedCampus;
    fetchPrayerTimes(savedCampus);

    selector.addEventListener('change', (e) => {
      const campus = e.target.value;
      localStorage.setItem('iium-prayer-campus', campus);
      fetchPrayerTimes(campus);
    });
  });
</script>

<style>
  .prayer-times {
    background: var(--sl-color-bg-nav);
    border: 1px solid var(--sl-color-hairline-light);
    border-radius: 12px;
    padding: 1.25rem;
    margin: 1.5rem 0;
  }

  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
  }

  .header h3 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
  }

  .header select {
    padding: 0.25rem 0.5rem;
    border: 1px solid var(--sl-color-hairline-light);
    border-radius: 6px;
    background: var(--sl-color-bg);
    color: inherit;
    font-size: 0.75rem;
  }

  .hijri-date {
    text-align: center;
    font-size: 0.875rem;
    color: var(--sl-color-gray-3);
    margin-bottom: 1rem;
  }

  .prayer-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }

  @media (max-width: 500px) {
    .prayer-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  .prayer-card {
    background: var(--sl-color-bg);
    border: 1px solid var(--sl-color-hairline-light);
    border-radius: 8px;
    padding: 0.75rem;
    text-align: center;
    transition: all 0.2s;
  }

  .prayer-card.next {
    border-color: var(--sl-color-accent);
    background: var(--sl-color-accent-low);
  }

  .prayer-card.loading {
    grid-column: 1 / -1;
  }

  .prayer-arabic {
    display: block;
    font-size: 0.875rem;
    color: var(--sl-color-gray-3);
    margin-bottom: 0.125rem;
  }

  .prayer-name {
    display: block;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }

  .prayer-time {
    display: block;
    font-size: 1rem;
    font-weight: 700;
    color: var(--sl-color-accent);
    margin-top: 0.25rem;
  }

  .next-prayer {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: 1rem;
    padding: 1rem;
    background: linear-gradient(135deg, var(--sl-color-accent) 0%, #2563eb 100%);
    border-radius: 8px;
    color: white;
  }

  .next-prayer .label {
    font-size: 0.625rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    opacity: 0.8;
  }

  .next-prayer .name {
    font-size: 1rem;
    font-weight: 600;
    margin: 0.25rem 0;
  }

  .next-prayer .countdown {
    font-size: 1.5rem;
    font-weight: 700;
    font-variant-numeric: tabular-nums;
  }

  .attribution {
    margin: 1rem 0 0 0;
    font-size: 0.625rem;
    color: #475569;
    text-align: center;
  }

  .attribution a {
    color: inherit;
  }

  .error {
    color: #ef4444;
    text-align: center;
    padding: 1rem;
  }
</style>
