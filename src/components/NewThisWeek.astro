---
/**
 * NewThisWeek Component
 * Displays resources added in the last 7 days
 * Uses GitHub API to fetch recent commits
 */
interface RecentResource {
	title: string;
	path: string;
	date: string;
}

// Fetch recent commits from GitHub
async function fetchRecentResources(): Promise<RecentResource[]> {
	try {
		const response = await fetch(
			'https://api.github.com/repos/iiumstudent/Awesome-IIUM/commits?per_page=20',
		);

		if (!response.ok) return [];

		const commits = await response.json();
		const sevenDaysAgo = new Date();
		sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

		const recentResources: RecentResource[] = [];

		for (const commit of commits) {
			const commitDate = new Date(commit.commit.author.date);
			if (commitDate < sevenDaysAgo) break;

			// Check if commit message indicates new content
			const message = commit.commit.message.toLowerCase();
			if (
				message.includes('add') ||
				message.includes('new') ||
				message.includes('feat')
			) {
				recentResources.push({
					title: commit.commit.message.split('\n')[0],
					path: commit.html_url,
					date: commitDate.toLocaleDateString(),
				});
			}
		}

		return recentResources.slice(0, 5);
	} catch {
		return [];
	}
}

const resources = await fetchRecentResources();
---

<div class="new-this-week not-content">
  <div class="header">
    <span class="badge">NEW</span>
    <h3>This Week</h3>
  </div>
  
  {resources.length > 0 ? (
    <ul class="resource-list">
      {resources.map((resource) => (
        <li>
          <a href={resource.path} target="_blank" rel="noopener">
            <span class="title">{resource.title}</span>
            <span class="date">{resource.date}</span>
          </a>
        </li>
      ))}
    </ul>
  ) : (
    <p class="no-updates">No new resources this week. <a href="/about/contributing">Contribute one!</a></p>
  )}
</div>

<style>
  .new-this-week {
    background: var(--sl-color-bg-nav);
    border: 1px solid var(--sl-color-hairline-light);
    border-radius: 12px;
    padding: 1rem;
    margin: 1.5rem 0;
  }

  .header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
  }

  .header h3 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
  }

  .badge {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    font-size: 0.625rem;
    font-weight: 700;
    padding: 0.125rem 0.5rem;
    border-radius: 9999px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  .resource-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .resource-list li {
    margin: 0;
    padding: 0;
  }

  .resource-list a {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--sl-color-hairline-light);
    text-decoration: none;
    color: inherit;
    transition: color 0.15s;
  }

  .resource-list li:last-child a {
    border-bottom: none;
  }

  .resource-list a:hover {
    color: var(--sl-color-accent);
  }

  .title {
    font-size: 0.875rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 70%;
  }

  .date {
    font-size: 0.75rem;
    color: var(--sl-color-gray-3);
    flex-shrink: 0;
  }

  .no-updates {
    font-size: 0.875rem;
    color: var(--sl-color-gray-3);
    margin: 0;
  }

  .no-updates a {
    color: var(--sl-color-accent);
  }
</style>
