---
// StatusDashboard.astro
import fs from 'node:fs/promises';
import path from 'node:path';

/**
 * StatusDashboard component
 *
 * Purpose: Display the health status of system services.
 * Usage: <StatusDashboard /> on the dashboard page.
 * Props: None.
 * Client behavior: Uses client script to refresh status data.
 * API dependencies: Local status JSON (`public/api/status.json`).
 */

// biome-ignore lint/correctness/noUnusedVariables: passed to client script
const BASE_URL = import.meta.env.BASE_URL;

interface SystemStatus {
	name: string;
	status: string;
	timestamp: string;
}

let initialStatus: SystemStatus[] = [];

try {
	const statusPath = path.join(process.cwd(), 'public/api/status.json');
	const fileContent = await fs.readFile(statusPath, 'utf-8');
	const parsed = JSON.parse(fileContent);

	if (Array.isArray(parsed)) {
		// Sanitize status to prevent CSS injection or invalid characters
		initialStatus = parsed.map((sys: SystemStatus) => ({
			...sys,
			status: (sys.status || '').replace(/[^a-z0-9-]/gi, ''),
		}));
	}
} catch (e) {
	// Ignore file not found errors (ENOENT) to match original behavior, log others
	if (
		e instanceof Error &&
		'code' in e &&
		(e as { code: string }).code !== 'ENOENT'
	) {
		console.error('Failed to load initial status', e);
	}
}

// biome-ignore lint/correctness/noUnusedVariables: passed to client script
const hasInitialData = initialStatus.length > 0;
---

<div id="status-dashboard" class="not-content">
  <div class="dashboard-header">
    <span class="last-updated" id="last-updated" aria-live="polite">
      Last updated: {initialStatus.length > 0 ? new Date().toLocaleString() : 'Loading...'}
    </span>
  </div>
  <div class="status-grid" id="status-grid">
    {
      initialStatus.length > 0 ? (
        initialStatus.map((sys) => (
          <div class={`status-card ${sys.status}`}>
            <div class="status-header">
              <span class="status-dot" />
              <h3>{sys.name}</h3>
            </div>
            <div class="status-body">
              <span class="status-label">{sys.status.toUpperCase()}</span>
              <span class="status-time">
                Last Checked: {new Date(sys.timestamp).toLocaleTimeString()}
              </span>
            </div>
          </div>
        ))
      ) : (
        <div class="loading">Loading system status...</div>
      )
    }
  </div>
</div>

<script define:vars={{ BASE_URL, hasInitialData }}>
  function updateLastUpdatedTimestamp() {
    const lastUpdated = document.getElementById('last-updated');
    if (lastUpdated) {
      lastUpdated.textContent = `Last updated: ${new Date().toLocaleString()}`;
    }
  }

  async function fetchStatus() {
    try {
      const baseUrl = BASE_URL.endsWith('/') ? BASE_URL : `${BASE_URL}/`;
      const response = await fetch(`${baseUrl}api/status.json`);
      const data = await response.json();

      if (!Array.isArray(data)) {
        throw new Error('Invalid status data format');
      }

      const grid = document.getElementById('status-grid');
      if (!grid) return;

      // Build all cards at once to avoid layout thrashing
      const cards = data.map((sys) => {
        const card = document.createElement('div');
        // Validate status class to alphanumeric characters only to prevent CSS injection
        const safeStatus = (sys.status || '').replace(/[^a-z0-9-]/gi, '');
        card.className = `status-card ${safeStatus}`;

        const header = document.createElement('div');
        header.className = 'status-header';

        const dot = document.createElement('span');
        dot.className = 'status-dot';

        const h3 = document.createElement('h3');
        h3.textContent = sys.name || 'Unknown System';

        header.appendChild(dot);
        header.appendChild(h3);

        const body = document.createElement('div');
        body.className = 'status-body';

        const label = document.createElement('span');
        label.className = 'status-label';
        label.textContent = (sys.status || '').toUpperCase();

        const time = document.createElement('span');
        time.className = 'status-time';
        try {
          time.textContent = `Last Checked: ${new Date(sys.timestamp).toLocaleTimeString()}`;
        } catch (e) {
          time.textContent = 'Last Checked: Unknown';
        }

        body.appendChild(label);
        body.appendChild(time);

        card.appendChild(header);
        card.appendChild(body);

        return card;
      });

      // Update grid in a single atomic operation
      grid.replaceChildren(...cards);

      // Update last updated timestamp
      updateLastUpdatedTimestamp();
    } catch (e) {
      console.error('Failed to fetch status', e);
    }
  }

  // Initial fetch if no SSG data
  if (!hasInitialData) {
    fetchStatus();
  }

  setInterval(fetchStatus, 300000); // Refresh every 5 minutes (matches cache TTL)
</script>

<style>
  .dashboard-header {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    margin-bottom: 1rem;
  }

  .last-updated {
    font-size: 0.85rem;
    color: var(--sl-color-gray-3);
    font-style: italic;
  }

  .status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-top: 2rem;
  }
  .status-card {
    background: var(--sl-color-bg-nav);
    padding: 1.5rem;
    border-radius: 12px;
    border: 1px solid var(--sl-color-hairline-light);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .status-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.1);
  }
  .status-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 1rem;
  }
  .status-header h3 {
    margin: 0 !important;
    font-size: 1.2rem !important;
  }
  .status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
  }
  .online .status-dot { background: #047857; box-shadow: 0 0 10px #047857; }
  .offline .status-dot { background: #ef4444; box-shadow: 0 0 10px #ef4444; }
  
  .status-body {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .status-label {
    font-weight: bold;
    font-size: 0.9rem;
  }
  .online .status-label { color: #047857; }
  .offline .status-label { color: #b91c1c; }
  
  .status-time {
    font-size: 0.8rem;
    color: var(--sl-color-gray-3);
  }
  .loading {
    grid-column: 1 / -1;
    text-align: center;
    padding: 3rem;
  }
</style>
